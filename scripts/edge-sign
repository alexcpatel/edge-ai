#!/bin/bash
# edge-sign: Build, push, and sign container images for Edge AI devices
#
# Prerequisites:
# - AWS CLI configured with permissions for ECR + KMS
# - Docker logged into ECR: aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_URL
# - cosign installed: https://docs.sigstore.dev/cosign/installation/
#
# Usage:
#   edge-sign build -t myapp:v1 .           # Build locally
#   edge-sign push myapp:v1                  # Push to ECR + sign
#   edge-sign build-push -t myapp:v1 .       # Build + push + sign in one step

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Load config
AWS_REGION="${AWS_REGION:-us-east-2}"
KMS_KEY_ALIAS="alias/edge-container-signing"

log() { echo "[edge-sign] $*"; }
err() { echo "[edge-sign] ERROR: $*" >&2; }
die() { err "$*"; exit 1; }

get_ecr_url() {
    aws ssm get-parameter \
        --name "/edge-ai/ecr/repository-url" \
        --region "$AWS_REGION" \
        --query "Parameter.Value" \
        --output text
}

ecr_login() {
    local ecr_url
    ecr_url=$(get_ecr_url)
    local registry="${ecr_url%%/*}"

    log "Logging into ECR: $registry"
    aws ecr get-login-password --region "$AWS_REGION" | \
        docker login --username AWS --password-stdin "$registry"
}

cmd_build() {
    log "Building image..."
    docker build "$@"
}

cmd_push() {
    local local_tag="${1:-}"
    [ -z "$local_tag" ] && die "Usage: edge-sign push <local-tag>"

    local ecr_url
    ecr_url=$(get_ecr_url)

    # Extract image name and tag
    local image_name="${local_tag%%:*}"
    local image_tag="${local_tag#*:}"
    [ "$image_tag" = "$local_tag" ] && image_tag="latest"

    local full_ecr_tag="${ecr_url}:${image_name}-${image_tag}"

    # Ensure logged in
    ecr_login

    # Tag for ECR
    log "Tagging: $local_tag -> $full_ecr_tag"
    docker tag "$local_tag" "$full_ecr_tag"

    # Push to ECR
    log "Pushing to ECR..."
    docker push "$full_ecr_tag"

    # Sign with cosign + KMS
    log "Signing with KMS..."
    cosign sign --key "awskms:///${KMS_KEY_ALIAS}" "$full_ecr_tag"

    log "Done! Image available at: $full_ecr_tag"
    log "Device pull command: edge-docker pull $full_ecr_tag"
}

cmd_build_push() {
    # Find the -t/--tag argument
    local tag=""
    local args=("$@")
    for i in "${!args[@]}"; do
        if [[ "${args[$i]}" == "-t" ]] || [[ "${args[$i]}" == "--tag" ]]; then
            tag="${args[$((i+1))]}"
            break
        fi
    done

    [ -z "$tag" ] && die "Must specify -t <tag>"

    cmd_build "$@"
    cmd_push "$tag"
}

cmd_verify() {
    local image="${1:-}"
    [ -z "$image" ] && die "Usage: edge-sign verify <image>"

    log "Fetching public key..."
    local pubkey
    pubkey=$(aws ssm get-parameter \
        --name "/edge-ai/pki/container-signing-public-key" \
        --region "$AWS_REGION" \
        --query "Parameter.Value" \
        --output text)

    local tmpkey=$(mktemp)
    echo "$pubkey" > "$tmpkey"

    log "Verifying signature for: $image"
    if cosign verify --key "$tmpkey" "$image"; then
        log "Signature valid!"
    else
        err "Signature verification failed!"
    fi

    rm -f "$tmpkey"
}

show_help() {
    cat <<EOF
edge-sign: Build, push, and sign container images for Edge AI devices

Commands:
  build <docker-build-args>     Build a container image locally
  push <local-tag>              Push local image to ECR and sign it
  build-push <docker-build-args> Build, push, and sign in one step
  verify <ecr-image>            Verify an image signature
  login                         Log into ECR

Examples:
  edge-sign build -t myapp:v1 .
  edge-sign push myapp:v1
  edge-sign build-push -t myapp:v1 ./path/to/Dockerfile/dir
  edge-sign verify 123456789.dkr.ecr.us-east-2.amazonaws.com/edge-ai:myapp-v1

Environment:
  AWS_REGION    AWS region (default: us-east-2)
EOF
}

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        build)
            cmd_build "$@"
            ;;
        push)
            cmd_push "$@"
            ;;
        build-push)
            cmd_build_push "$@"
            ;;
        verify)
            cmd_verify "$@"
            ;;
        login)
            ecr_login
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            die "Unknown command: $cmd. Use 'edge-sign help' for usage."
            ;;
    esac
}

main "$@"


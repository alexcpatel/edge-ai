# KAS (Kernel Automation System) configuration for Yocto project
# This file manages all Yocto layers, repositories, and build configuration
# See: https://kas.readthedocs.io/

header:
  version: 15

machine: jetson-orin-nano-devkit-nvme
distro: poky
target:
  - core-image-weston
  - core-image-weston:do_populate_sdk

repos:
  poky:
    url: git://git.yoctoproject.org/poky
    branch: scarthgap
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: https://github.com/openembedded/meta-openembedded.git
    branch: scarthgap
    layers:
      meta-oe:
      meta-python:
      meta-networking:
      meta-multimedia:

  meta-tegra:
    url: https://github.com/OE4T/meta-tegra.git
    branch: scarthgap
    layers:
      .:

local_conf_header:

  tegra-config: |
    # Use Tegraflash format for flashing NVMe
    IMAGE_CLASSES += "image_types_tegra"
    IMAGE_FSTYPES = "tegraflash"

    DISTRO_FEATURES:append = " wayland opengl"

    # Enable debug-tweaks for serial console
    EXTRA_IMAGE_FEATURES += "debug-tweaks"

    BB_NUMBER_THREADS = "8"
    PARALLEL_MAKE = "-j8"

    # NV GPU drivers (mandatory even if userland lives in containers)
    IMAGE_INSTALL:append = " nvgpu-libs"

  container-runtime: |
    # Install Docker as container runtime
    DISTRO_FEATURES:append = " virtualization"
    IMAGE_INSTALL:append = " docker docker-contrib"

    # Enable Docker daemon at boot
    SYSTEMD_AUTO_ENABLE:append = " docker.service"

    # NVIDIA Container Runtime (for CUDA inside containers)
    IMAGE_INSTALL:append = " nvidia-container-runtime"
    IMAGE_INSTALL:append = " libnvidia-container-tools libnvidia-container1"
    IMAGE_INSTALL:append = " libnvidia-container-dev"

    # Allow container pull/provisioning
    IMAGE_INSTALL:append = " ca-certificates curl"

  bootstrap-runtime: |
    # Items needed for first-boot provisioning script
    IMAGE_INSTALL:append = " bash openssh rsync util-linux"

    # Directory for provisioning state
    IMAGE_INSTALL:append = " e2fsprogs-mke2fs"

    # TPM (optional but recommended for key storage)
    IMAGE_INSTALL:append = " tpm2-tss tpm2-tools"

  sdk-config: |
    TOOLCHAIN_HOST_TASK:append = " nativesdk-cmake nativesdk-ninja"
    TOOLCHAIN_TARGET_TASK:append = " tegra-mmapi-dev libstdc++-dev"

  system-config: |
    # Set hostname
    hostname:pn-base-files = "edge-ai"

    # Create writable data partition mount points
    ROOTFS_POSTPROCESS_COMMAND += "create_data_dirs; "

    create_data_dirs () {
        install -d ${IMAGE_ROOTFS}/data
        install -d ${IMAGE_ROOTFS}/var/lib/docker
        touch ${IMAGE_ROOTFS}/data/need_provisioning
    }

bblayers_conf_header:
  layers-config: |
